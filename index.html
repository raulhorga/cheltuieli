<!doctype html>
<html lang="ro">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Cheltuieli (auto din cheltuieli.csv)</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial; margin: 16px; line-height: 1.3; }
    .row { display: grid; grid-template-columns: 1fr; gap: 14px; max-width: 1300px; }
    .card { border: 1px solid #e5e7eb; border-radius: 14px; padding: 14px; box-shadow: 0 2px 10px rgba(0,0,0,.04); background:#fff; }
    .grid { display: grid; grid-template-columns: repeat(4, minmax(0,1fr)); gap: 10px; }
    label { font-size: 12px; color: #374151; display:block; margin-bottom: 6px; }
    input, select, button, textarea { width: 100%; box-sizing: border-box; padding: 10px; border-radius: 10px; border: 1px solid #d1d5db; background: #fff; }
    textarea { min-height: 42px; resize: vertical; }
    button { cursor:pointer; border: 0; }
    .btn { background:#111827; color:#fff; }
    .btn2 { background:#e5e7eb; color:#111827; }
    .muted { color:#6b7280; font-size: 12px; }
    .actions { display:flex; gap: 10px; flex-wrap: wrap; align-items: center; }
    .grid2 { display:grid; grid-template-columns: 2fr 1fr 1fr 1fr; gap:10px; }

    .pill { display:inline-block; padding:4px 8px; border-radius:999px; background:#f3f4f6; font-size:12px; }
    .ok { color:#065f46; }
    .bad { color:#991b1b; }
    code { background:#f3f4f6; padding:2px 6px; border-radius:8px; }

    /* Chart + list side-by-side */
    .chartAndList { display:grid; grid-template-columns: 2fr 1.15fr; gap: 14px; align-items: start; }
    .panelTitle { display:flex; align-items: baseline; justify-content: space-between; gap: 10px; margin: 0 0 8px 0; }
    .scroll { max-height: 560px; overflow: auto; border: 1px solid #e5e7eb; border-radius: 12px; }
    table { width: 100%; border-collapse: collapse; font-size: 12px; }
    thead th { position: sticky; top: 0; background: #fafafa; border-bottom: 1px solid #e5e7eb; text-align: left; padding: 10px; }
    tbody td { border-bottom: 1px solid #f0f0f0; padding: 10px; vertical-align: top; }
    tbody tr:hover { background: #fcfcfc; }
    .mono { font-variant-numeric: tabular-nums; }
    .right { text-align:right; }
    .small { font-size: 11px; color:#6b7280; }

    .filters { display:grid; grid-template-columns: 1fr 1fr 1fr; gap:8px; margin: 0 0 10px 0; }

    /* Mobile: make everything stack and make chart readable via horizontal scroll */
    @media (max-width: 1100px) {
      .chartAndList { grid-template-columns: 1fr; }
      .filters { grid-template-columns: 1fr; }
    }
    @media (max-width: 900px) {
      .grid, .grid2 { grid-template-columns: 1fr; }
      body { margin: 12px; }
    }

    /* Chart responsiveness improvements */
    .chartWrap {
      border: 1px solid #e5e7eb;
      border-radius: 12px;
      padding: 10px;
      overflow-x: auto;          /* key: allow horizontal scroll on small screens */
      -webkit-overflow-scrolling: touch;
      background: #fff;
    }
    .chartInner {
      min-width: 720px;          /* ensures labels don't squeeze; scrolls on mobile */
    }
    @media (max-width: 700px) {
      .chartInner { min-width: 820px; } /* a bit wider for very small screens */
    }
    canvas { display:block; }
  </style>
</head>
<body>
  <div class="row">
    <div class="card">
      <h2 style="margin:0 0 8px 0;">Cheltuieli (auto-load)</h2>
      <div class="muted">
        Pagina citește automat <b>cheltuieli.csv</b> aflat lângă <b>index.html</b>.
        <br/>
      </div>

      <div style="height:10px;"></div>

      <div class="grid2">
        <div>
          <label>Status</label>
          <div id="status" class="muted"></div>
        </div>

        <div>
          <label>De la data</label>
          <input id="fromDate" type="date" />
        </div>

        <div>
          <label>Până la data</label>
          <input id="toDate" type="date" />
        </div>

        <div style="display:flex; align-items:end;">
          <button class="btn2" id="applyRange">Aplică interval</button>
        </div>
      </div>

      <div style="height:14px;"></div>

      <div class="chartAndList">
        <div>
          <div class="chartWrap" aria-label="Grafic cheltuieli">
            <div class="chartInner">
              <canvas id="chart" height="360"></canvas>
            </div>
          </div>
          <div class="small muted" style="margin-top:6px;">
            Pe mobil, graficul are scroll orizontal pentru lizibilitate. Deasupra fiecărei zile vezi totalul cheltuit.
          </div>
        </div>

        <div>
          <div class="panelTitle">
            <h3 style="margin:0;">Lista cheltuieli</h3>
            <div class="small"><span id="listCount">0</span> intrări</div>
          </div>

          <div class="filters">
            <div>
              <label>Luna</label>
              <select id="monthFilter"></select>
            </div>
            <div>
              <label>Tip cheltuială</label>
              <select id="typeFilter"></select>
            </div>
            <div>
              <label>Sortare</label>
              <select id="sortFilter">
                <option value="date_asc">Data ↑</option>
                <option value="date_desc">Data ↓</option>
                <option value="amount_desc">Sumă ↓</option>
                <option value="amount_asc">Sumă ↑</option>
              </select>
            </div>
          </div>

          <div class="scroll">
            <table>
              <thead>
                <tr>
                  <th>Data</th>
                  <th>Categorie</th>
                  <th class="right">Sumă</th>
                  <th>Comentariu</th>
                </tr>
              </thead>
              <tbody id="expenseTbody">
                <tr><td colspan="4" class="muted">Încarc date...</td></tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <div class="card">
      <h3 style="margin:0 0 10px 0;">Adaugă cheltuială</h3>

      <div class="grid">
        <div>
          <label>Data</label>
          <input id="addDate" type="date" />
        </div>

        <div>
          <label>Tip cheltuială</label>
          <select id="addType"></select>
        </div>

        <div>
          <label>Sumă</label>
          <input id="addAmount" type="number" step="0.01" />
        </div>

        <div>
          <label>&nbsp;</label>
          <button class="btn" id="addBtn">Adaugă</button>
        </div>
      </div>

      <div style="height:10px;"></div>

      <div>
        <label>Comentariu (opțional, se salvează pe zi)</label>
        <textarea id="addComment"></textarea>
      </div>

      <div style="height:12px;"></div>

      <div class="actions">
        <button class="btn2" id="downloadBtn">Descarcă cheltuieli_updated.csv</button>
        <button class="btn2" id="downloadLongBtn">Descarcă cheltuieli_long.csv</button>
      </div>

      <div id="addMsg" class="muted" style="margin-top:10px;"></div>
    </div>
  </div>

<script>
function splitCSVLine(line, delim=',') { return line.split(delim); }
function toNumber(v) {
  const s = String(v ?? '').trim();
  if (!s) return 0;
  const n = Number(s.replace(',', '.'));
  return Number.isFinite(n) ? n : 0;
}
function pad2(x){ return String(x).padStart(2,'0'); }
function ymdToISO(y,m,d){ return `${y}-${pad2(m)}-${pad2(d)}`; }
function isoToYMD(iso){ const [y,m,d]=iso.split('-').map(Number); return {y,m,d}; }
function isoToYM(iso){ return iso.slice(0,7); }

const el = (id) => document.getElementById(id);

let rawHeaders = [];
let rows = [];
let categories = [];
let chart = null;

function isMobile() {
  return window.matchMedia && window.matchMedia('(max-width: 700px)').matches;
}

const totalsPlugin = {
  id: 'totalsPlugin',
  afterDatasetsDraw(chart, args, pluginOptions) {
    const { ctx } = chart;
    const datasets = chart.data.datasets || [];
    if (!datasets.length) return;

    const meta0 = chart.getDatasetMeta(0);
    if (!meta0 || !meta0.data) return;

    const totals = meta0.data.map((_, i) => {
      let sum = 0;
      for (const ds of datasets) {
        const v = Number(ds.data?.[i] ?? 0);
        if (Number.isFinite(v)) sum += v;
      }
      return sum;
    });

    ctx.save();
    ctx.textAlign = 'center';
    ctx.textBaseline = 'bottom';
    ctx.font = (isMobile() ? '11px' : '12px') + ' system-ui, -apple-system, Segoe UI, Roboto, Arial';

    for (let i = 0; i < meta0.data.length; i++) {
      const total = totals[i];
      if (total <= 0) continue;

      let yTop = null;
      let x = null;
      for (let di = 0; di < datasets.length; di++) {
        const m = chart.getDatasetMeta(di);
        const pt = m?.data?.[i];
        if (!pt) continue;
        const p = pt.getProps(['x','y'], true);
        x = p.x;
        yTop = (yTop === null) ? p.y : Math.min(yTop, p.y);
      }
      if (x === null || yTop === null) continue;

      ctx.fillText(total.toFixed(2), x, yTop - (isMobile() ? 4 : 6));
    }
    ctx.restore();
  }
};

function setStatus(msg, ok=true){
  el('status').innerHTML = `<span style="color:${ok ? '#065f46' : '#991b1b'}">${msg}</span>`;
}

function parseCSV(text) {
  const lines = text.replace(/\r\n/g, '\n').replace(/\r/g, '\n').split('\n').filter(l => l.trim().length>0);
  if (lines.length < 2) throw new Error("CSV prea scurt / gol.");

  rawHeaders = splitCSVLine(lines[0], ',').map(h => h.trim()).filter(h => h.length>0);
  if (!rawHeaders.includes('comentariu')) rawHeaders.push('comentariu');

  const out = [];
  for (let i=1;i<lines.length;i++){
    const parts = splitCSVLine(lines[i], ',');
    const obj = {};
    rawHeaders.forEach((h, idx) => obj[h] = (parts[idx] ?? '').trim());
    out.push(obj);
  }
  rows = out;
}

function inferSchema() {
  categories = rawHeaders.filter(h => !['an','luna','zi','comentariu'].includes(h));
  el('addType').innerHTML = categories.map(c => `<option value="${c}">${c}</option>`).join('');
}

function suggestDateRangeDefaults() {
  if (!rows.length) return;
  const dates = rows.map(r => ymdToISO(Number(r.an), Number(r.luna), Number(r.zi))).sort();
  el('fromDate').value = dates[0];
  el('toDate').value = dates[dates.length-1];
  el('addDate').value = dates[dates.length-1];
}

function getFilteredRowsByRange() {
  const f = el('fromDate').value || null;
  const t = el('toDate').value || null;
  return rows.filter(r => {
    const iso = ymdToISO(Number(r.an), Number(r.luna), Number(r.zi));
    if (f && iso < f) return false;
    if (t && iso > t) return false;
    return true;
  });
}

function normalizeForChart(filteredRows) {
  const data = filteredRows
    .map(r => ({ iso: ymdToISO(Number(r.an), Number(r.luna), Number(r.zi)), r }))
    .sort((a,b) => a.iso.localeCompare(b.iso));

  const labels = data.map(x => x.iso);
  const datasets = categories.map(cat => ({
    label: cat,
    data: data.map(x => toNumber(x.r[cat])),
    stack: 'stack1',
    borderWidth: 0
  }));
  return { labels, datasets };
}

function renderChart() {
  const filtered = getFilteredRowsByRange();
  const { labels, datasets } = normalizeForChart(filtered);

  if (chart) chart.destroy();

  const mobile = isMobile();

  chart = new Chart(el('chart'), {
    type: 'bar',
    data: { labels, datasets },
    options: {
      responsive: true,
      maintainAspectRatio: false,                 // key for mobile height control
      layout: { padding: { top: mobile ? 18 : 22 } }, // room for totals above bars
      interaction: { mode: 'index', intersect: false },
      plugins: {
        legend: { position: 'bottom', labels: { boxWidth: mobile ? 10 : 12 } },
        tooltip: { callbacks: {
          footer: (items) => {
            const sum = items.reduce((acc, it) => acc + (it.parsed.y || 0), 0);
            return `Total zi: ${sum.toFixed(2)}`;
          }
        }}
      },
      scales: {
        x: {
          stacked:true,
          ticks: {
            autoSkip: true,
            maxTicksLimit: mobile ? 6 : 12,
            maxRotation: mobile ? 45 : 0,
            minRotation: mobile ? 45 : 0
          }
        },
        y: {
          stacked:true,
          beginAtZero:true,
          ticks: {
            maxTicksLimit: mobile ? 5 : 8
          }
        }
      }
    },
    plugins: [totalsPlugin]
  });

  // set explicit canvas height (in CSS terms) for mobile/desktop
  el('chart').style.height = mobile ? '320px' : '360px';
}

function buildExpenseEntries(filteredRows) {
  const entries = [];
  for (const r of filteredRows) {
    const date = ymdToISO(Number(r.an), Number(r.luna), Number(r.zi));
    const ym = isoToYM(date);
    const comment = (r.comentariu ?? '').toString().trim();
    for (const c of categories) {
      const amount = toNumber(r[c]);
      if (amount !== 0) entries.push({ date, ym, category: c, amount, comment });
    }
  }
  entries.sort((a,b) => a.date.localeCompare(b.date) || a.category.localeCompare(b.category));
  return entries;
}

function populateListFilters(allEntries) {
  const months = Array.from(new Set(allEntries.map(e => e.ym))).sort();
  const types = Array.from(new Set(allEntries.map(e => e.category))).sort();

  const prevMonth = el('monthFilter').value;
  const prevType = el('typeFilter').value;

  el('monthFilter').innerHTML = ['<option value="__all__">Toate</option>', ...months.map(m => `<option value="${m}">${m}</option>`)].join('');
  el('typeFilter').innerHTML = ['<option value="__all__">Toate</option>', ...types.map(t => `<option value="${t}">${t}</option>`)].join('');

  el('monthFilter').value = (prevMonth && months.includes(prevMonth)) ? prevMonth : '__all__';
  el('typeFilter').value  = (prevType && types.includes(prevType)) ? prevType : '__all__';
}

function applyEntryFiltersAndSort(entries) {
  const month = el('monthFilter').value;
  const type = el('typeFilter').value;
  const sort = el('sortFilter').value;

  let out = entries.slice();
  if (month && month !== '__all__') out = out.filter(e => e.ym === month);
  if (type && type !== '__all__') out = out.filter(e => e.category === type);

  out.sort((a,b) => {
    if (sort === 'date_asc') return a.date.localeCompare(b.date) || a.category.localeCompare(b.category) || (a.amount - b.amount);
    if (sort === 'date_desc') return b.date.localeCompare(a.date) || a.category.localeCompare(b.category) || (b.amount - a.amount);
    if (sort === 'amount_desc') return (b.amount - a.amount) || b.date.localeCompare(a.date) || a.category.localeCompare(b.category);
    if (sort === 'amount_asc') return (a.amount - b.amount) || a.date.localeCompare(b.date) || a.category.localeCompare(b.category);
    return 0;
  });

  return out;
}

function renderExpenseList() {
  const filteredRows = getFilteredRowsByRange();
  const allEntries = buildExpenseEntries(filteredRows);

  populateListFilters(allEntries);

  const entries = applyEntryFiltersAndSort(allEntries);
  el('listCount').textContent = String(entries.length);

  const tbody = el('expenseTbody');
  if (!entries.length) {
    tbody.innerHTML = `<tr><td colspan="4" class="muted">Nu există cheltuieli în filtrul curent.</td></tr>`;
    return;
  }

  tbody.innerHTML = entries.map(e => {
    const comm = e.comment ? e.comment.replace(/</g,'&lt;').replace(/>/g,'&gt;') : '';
    return `
      <tr>
        <td class="mono">${e.date}</td>
        <td>${e.category}</td>
        <td class="right mono">${e.amount.toFixed(2)}</td>
        <td>${comm}</td>
      </tr>
    `;
  }).join('');
}

function addExpense() {
  if (!rows.length) { el('addMsg').innerHTML = '<span style="color:#991b1b">Nu am date încă.</span>'; return; }

  const iso = el('addDate').value;
  const type = el('addType').value;
  const amount = toNumber(el('addAmount').value);
  const comment = (el('addComment').value || '').trim();

  if (!iso) return el('addMsg').innerHTML = '<span style="color:#991b1b">Alege o dată.</span>';
  if (!type) return el('addMsg').innerHTML = '<span style="color:#991b1b">Alege un tip.</span>';
  if (!(amount > 0)) return el('addMsg').innerHTML = '<span style="color:#991b1b">Introdu o sumă > 0.</span>';

  const { y, m, d } = isoToYMD(iso);

  let row = rows.find(r => Number(r.an)===y && Number(r.luna)===m && Number(r.zi)===d);
  if (!row) {
    row = {};
    rawHeaders.forEach(h => row[h] = '');
    row.an = String(y);
    row.luna = String(m);
    row.zi = String(d);
    categories.forEach(c => row[c] = '0');
    row.comentariu = '';
    rows.push(row);
  }

  const prev = toNumber(row[type]);
  row[type] = String((prev + amount).toFixed(2));

  if (comment) {
    const prevC = (row.comentariu || '').trim();
    row.comentariu = prevC ? `${prevC} | ${comment}` : comment;
  }

  el('addAmount').value = '';
  el('addComment').value = '';
  el('addMsg').innerHTML = `<span style="color:#065f46">OK:</span> ${iso} +${amount.toFixed(2)} la <b>${type}</b>.`;

  renderChart();
  renderExpenseList();
}

function toCSVWide() {
  const head = ['an','luna','zi', ...categories, 'comentariu'];
  const sorted = rows.slice().sort((a,b) => {
    const da = ymdToISO(+a.an,+a.luna,+a.zi);
    const db = ymdToISO(+b.an,+b.luna,+b.zi);
    return da.localeCompare(db);
  });
  const lines = [];
  lines.push(head.join(',') + ',');
  for (const r of sorted) lines.push(head.map(h => (r[h] ?? '').toString()).join(',') + ',');
  return lines.join('\n');
}

function toCSVLong() {
  const lines = ['data;tip;suma;comentariu'];
  const sorted = rows.slice().sort((a,b) => {
    const da = ymdToISO(+a.an,+a.luna,+a.zi);
    const db = ymdToISO(+b.an,+b.luna,+b.zi);
    return da.localeCompare(db);
  });
  for (const r of sorted) {
    const iso = ymdToISO(+r.an,+r.luna,+r.zi);
    const comm = (r.comentariu ?? '').toString().replace(/\n/g, ' ').trim();
    for (const c of categories) {
      const v = toNumber(r[c]);
      if (v !== 0) lines.push(`${iso};${c};${v.toFixed(2)};${comm}`);
    }
  }
  return lines.join('\n');
}

function downloadText(filename, text) {
  const blob = new Blob([text], { type: 'text/csv;charset=utf-8' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = filename;
  document.body.appendChild(a);
  a.click();
  a.remove();
  URL.revokeObjectURL(url);
}

async function loadCSV() {
  const res = await fetch('cheltuieli.csv', { cache: 'no-store' });
  if (!res.ok) throw new Error(`Nu pot citi cheltuieli.csv (HTTP ${res.status}).`);
  const text = await res.text();

  parseCSV(text);
  inferSchema();
  suggestDateRangeDefaults();
  renderChart();
  renderExpenseList();

  setStatus(`Încărcat cheltuieli.csv (${rows.length} zile)`, true);
}

window.addEventListener('load', () => {
  setStatus('Încarc cheltuieli.csv ...', true);
  loadCSV().catch(err => {
    console.error(err);
    setStatus(`Eroare: ${err.message}`, false);
    el('expenseTbody').innerHTML = `<tr><td colspan="4" class="muted">Nu s-au putut încărca datele.</td></tr>`;
  });
});

el('applyRange').addEventListener('click', () => { renderChart(); renderExpenseList(); });
el('addBtn').addEventListener('click', addExpense);
el('downloadBtn').addEventListener('click', () => downloadText('cheltuieli_updated.csv', toCSVWide()));
el('downloadLongBtn').addEventListener('click', () => downloadText('cheltuieli_long.csv', toCSVLong()));

el('monthFilter').addEventListener('change', renderExpenseList);
el('typeFilter').addEventListener('change', renderExpenseList);
el('sortFilter').addEventListener('change', renderExpenseList);

// Re-render chart on orientation / resize (so ticks + heights adjust)
window.addEventListener('resize', () => {
  if (!rows.length) return;
  renderChart();
});
</script>
</body>
</html>



