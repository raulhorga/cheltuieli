<!doctype html>
<html lang="ro">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Cheltuieli (auto din cheltuieli.csv)</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial; margin: 20px; line-height: 1.3; }
    .row { display: grid; grid-template-columns: 1fr; gap: 14px; max-width: 1100px; }
    .card { border: 1px solid #e5e7eb; border-radius: 14px; padding: 14px; box-shadow: 0 2px 10px rgba(0,0,0,.04); }
    .grid { display: grid; grid-template-columns: repeat(4, minmax(0,1fr)); gap: 10px; }
    label { font-size: 12px; color: #374151; display:block; margin-bottom: 6px; }
    input, select, button, textarea { width: 100%; box-sizing: border-box; padding: 10px; border-radius: 10px; border: 1px solid #d1d5db; }
    textarea { min-height: 42px; resize: vertical; }
    button { cursor:pointer; border: 0; }
    .btn { background:#111827; color:#fff; }
    .btn2 { background:#e5e7eb; color:#111827; }
    .muted { color:#6b7280; font-size: 12px; }
    .actions { display:flex; gap: 10px; flex-wrap: wrap; }
    .grid2 { display:grid; grid-template-columns: 2fr 1fr 1fr 1fr; gap:10px; }
    @media (max-width: 900px) { .grid, .grid2 { grid-template-columns: 1fr; } }
    canvas { max-height: 520px; }
    .pill { display:inline-block; padding:4px 8px; border-radius:999px; background:#f3f4f6; font-size:12px; }
    .ok { color:#065f46; }
    .bad { color:#991b1b; }
    code { background:#f3f4f6; padding:2px 6px; border-radius:8px; }
  </style>
</head>



<body>

<h2>Cheltuieli</h2>
<button id="saveBtn">ðŸ’¾ SalveazÄƒ Ã®n cheltuieli.csv</button>
<canvas id="chart"></canvas>

<script>
async function saveCSVToDisk(csv) {
  await fetch("/save-csv", { method:"POST", body: csv });
  alert("Salvat!");
}
document.getElementById("saveBtn").onclick = () => saveCSVToDisk("an;luna;zi;test;\n2025;1;1;10;");
</script>

  <div class="row">
    <div class="card">
      <h2 style="margin:0 0 8px 0;">Cheltuieli (auto-load)</h2>
      <div class="muted">
        AceastÄƒ paginÄƒ Ã®ncearcÄƒ sÄƒ citeascÄƒ automat fiÈ™ierul <b>cheltuieli.csv</b> aflat lÃ¢ngÄƒ <b>index.html</b>, prin <span class="pill">fetch</span>.
        <br/>
        <b>Important:</b> trebuie rulatÄƒ printr-un server local (ex: <code>python -m http.server 8000</code>) È™i deschisÄƒ la <code>http://localhost:8000</code>.
      </div>

      <div style="height:10px;"></div>

      <div class="grid2">
        <div>
          <label>Status</label>
          <div id="status" class="muted"></div>
        </div>

        <div>
          <label>De la data</label>
          <input id="fromDate" type="date" />
        </div>

        <div>
          <label>PÃ¢nÄƒ la data</label>
          <input id="toDate" type="date" />
        </div>

        <div style="display:flex; align-items:end;">
          <button class="btn2" id="applyRange">AplicÄƒ interval</button>
        </div>
      </div>

      <div style="height:14px;"></div>

      <canvas id="chart"></canvas>
    </div>

    <div class="card">
      <h3 style="margin:0 0 10px 0;">AdaugÄƒ cheltuialÄƒ</h3>

      <div class="grid">
        <div>
          <label>Data</label>
          <input id="addDate" type="date" />
        </div>

        <div>
          <label>Tip cheltuialÄƒ</label>
          <select id="addType"></select>
        </div>

        <div>
          <label>SumÄƒ</label>
          <input id="addAmount" type="number" step="0.01" />
        </div>

        <div>
          <label>&nbsp;</label>
          <button class="btn" id="addBtn">AdaugÄƒ</button>
        </div>
      </div>

      <div style="height:10px;"></div>

      <div>
        <label>Comentariu (opÈ›ional, se salveazÄƒ pe zi)</label>
        <textarea id="addComment"></textarea>
      </div>

      <div style="height:12px;"></div>

      <div class="actions">
        <button class="btn2" id="downloadBtn">DescarcÄƒ cheltuieli_updated.csv</button>
        <button class="btn2" id="downloadLongBtn">DescarcÄƒ cheltuieli_long.csv</button>
      </div>

      <div id="addMsg" class="muted" style="margin-top:10px;"></div>
    </div>
  </div>

<script>
/** ======= Utilitare CSV ======= **/
function splitCSVLine(line, delim=';') { return line.split(delim); }
function toNumber(v) {
  const s = String(v ?? '').trim();
  if (!s) return 0;
  const n = Number(s.replace(',', '.'));
  return Number.isFinite(n) ? n : 0;
}
function pad2(x){ return String(x).padStart(2,'0'); }
function ymdToISO(y,m,d){ return `${y}-${pad2(m)}-${pad2(d)}`; }
function isoToYMD(iso){ const [y,m,d]=iso.split('-').map(Number); return {y,m,d}; }

const el = (id) => document.getElementById(id);

/** ======= Stare ======= **/
let rawHeaders = [];
let rows = [];
let categories = [];
let chart = null;

function setStatus(msg, ok=true){
  el('status').innerHTML = `<span class="${ok ? 'ok':'bad'}">${msg}</span>`;
}

function parseCSV(text) {
  const lines = text.replace(/\r\n/g, '\n').replace(/\r/g, '\n').split('\n').filter(l => l.trim().length>0);
  if (lines.length < 2) throw new Error("CSV prea scurt / gol.");

  rawHeaders = splitCSVLine(lines[0], ';').map(h => h.trim()).filter(h => h.length>0);
  if (!rawHeaders.includes('comentariu')) rawHeaders.push('comentariu');

  const out = [];
  for (let i=1;i<lines.length;i++){
    const parts = splitCSVLine(lines[i], ';');
    const obj = {};
    rawHeaders.forEach((h, idx) => obj[h] = (parts[idx] ?? '').trim());
    out.push(obj);
  }
  rows = out;
}

function inferSchema() {
  categories = rawHeaders.filter(h => !['an','luna','zi','comentariu'].includes(h));
  el('addType').innerHTML = categories.map(c => `<option value="${c}">${c}</option>`).join('');
}

function suggestDateRangeDefaults() {
  if (!rows.length) return;
  const dates = rows.map(r => ymdToISO(Number(r.an), Number(r.luna), Number(r.zi))).sort();
  el('fromDate').value = dates[0];
  el('toDate').value = dates[dates.length-1];
  el('addDate').value = dates[dates.length-1];
}

function normalizeForChart(filteredRows) {
  const data = filteredRows
    .map(r => ({ iso: ymdToISO(Number(r.an), Number(r.luna), Number(r.zi)), r }))
    .sort((a,b) => a.iso.localeCompare(b.iso));

  const labels = data.map(x => x.iso);
  const datasets = categories.map(cat => ({
    label: cat,
    data: data.map(x => toNumber(x.r[cat])),
    stack: 'stack1'
  }));
  return { labels, datasets };
}

function renderChart() {
  const f = el('fromDate').value || null;
  const t = el('toDate').value || null;

  const filtered = rows.filter(r => {
    const iso = ymdToISO(Number(r.an), Number(r.luna), Number(r.zi));
    if (f && iso < f) return false;
    if (t && iso > t) return false;
    return true;
  });

  const { labels, datasets } = normalizeForChart(filtered);

  if (chart) chart.destroy();
  chart = new Chart(el('chart'), {
    type: 'bar',
    data: { labels, datasets },
    options: {
      responsive: true,
      interaction: { mode: 'index', intersect: false },
      plugins: {
        legend: { position: 'bottom' },
        tooltip: { callbacks: {
          footer: (items) => {
            const sum = items.reduce((acc, it) => acc + (it.parsed.y || 0), 0);
            return `Total zi: ${sum.toFixed(2)}`;
          }
        }}
      },
      scales: { x: { stacked:true }, y: { stacked:true, beginAtZero:true } }
    }
  });
}

/** ======= Add/update ======= **/
function addExpense() {
  if (!rows.length) { el('addMsg').innerHTML = '<span class="bad">Nu am date Ã®ncÄƒ.</span>'; return; }

  const iso = el('addDate').value;
  const type = el('addType').value;
  const amount = toNumber(el('addAmount').value);
  const comment = (el('addComment').value || '').trim();

  if (!iso) return el('addMsg').innerHTML = '<span class="bad">Alege o datÄƒ.</span>';
  if (!type) return el('addMsg').innerHTML = '<span class="bad">Alege un tip.</span>';
  if (!(amount > 0)) return el('addMsg').innerHTML = '<span class="bad">Introdu o sumÄƒ > 0.</span>';

  const { y, m, d } = isoToYMD(iso);

  let row = rows.find(r => Number(r.an)===y && Number(r.luna)===m && Number(r.zi)===d);
  if (!row) {
    row = {};
    rawHeaders.forEach(h => row[h] = '');
    row.an = String(y);
    row.luna = String(m);
    row.zi = String(d);
    categories.forEach(c => row[c] = '0');
    row.comentariu = '';
    rows.push(row);
  }

  const prev = toNumber(row[type]);
  row[type] = String((prev + amount).toFixed(2));

  if (comment) {
    const prevC = (row.comentariu || '').trim();
    row.comentariu = prevC ? `${prevC} | ${comment}` : comment;
  }

  el('addAmount').value = '';
  el('addComment').value = '';
  el('addMsg').innerHTML = `<span class="ok">OK:</span> ${iso} +${amount.toFixed(2)} la <b>${type}</b>.`;

  renderChart();
}

/** ======= Export ======= **/
function toCSVWide() {
  const head = ['an','luna','zi', ...categories, 'comentariu'];
  const sorted = rows.slice().sort((a,b) => {
    const da = ymdToISO(+a.an,+a.luna,+a.zi);
    const db = ymdToISO(+b.an,+b.luna,+b.zi);
    return da.localeCompare(db);
  });
  const lines = [];
  lines.push(head.join(';') + ';');
  for (const r of sorted) lines.push(head.map(h => (r[h] ?? '').toString()).join(';') + ';');
  return lines.join('\n');
}

function toCSVLong() {
  const lines = ['data;tip;suma;comentariu'];
  const sorted = rows.slice().sort((a,b) => {
    const da = ymdToISO(+a.an,+a.luna,+a.zi);
    const db = ymdToISO(+b.an,+b.luna,+b.zi);
    return da.localeCompare(db);
  });
  for (const r of sorted) {
    const iso = ymdToISO(+r.an,+r.luna,+r.zi);
    const comm = (r.comentariu ?? '').toString().replace(/\n/g, ' ').trim();
    for (const c of categories) {
      const v = toNumber(r[c]);
      if (v !== 0) lines.push(`${iso};${c};${v.toFixed(2)};${comm}`);
    }
  }
  return lines.join('\n');
}

function downloadText(filename, text) {
  const blob = new Blob([text], { type: 'text/csv;charset=utf-8' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = filename;
  document.body.appendChild(a);
  a.click();
  a.remove();
  URL.revokeObjectURL(url);
}

/** ======= Auto-load cheltuieli.csv ======= **/
async function loadCSV() {
  // IMPORTANT: merge doar din http:// (server local), nu prin dublu-click (file://)
  const res = await fetch('cheltuieli.csv', { cache: 'no-store' });
  if (!res.ok) throw new Error(`Nu pot citi cheltuieli.csv (HTTP ${res.status}).`);
  const text = await res.text();

  parseCSV(text);
  inferSchema();
  suggestDateRangeDefaults();
  renderChart();

  setStatus(`ÃŽncÄƒrcat automat cheltuieli.csv (${rows.length} zile)`, true);
}

window.addEventListener('load', () => {
  setStatus('ÃŽncerc sÄƒ Ã®ncarc automat cheltuieli.csv ...', true);
  loadCSV().catch(err => {
    console.error(err);
    setStatus(
      `Eroare la Ã®ncÄƒrcare automatÄƒ: ${err.message}<br/>
      <span class="muted">RuleazÄƒ din folderul cu fiÈ™ierele:</span>
      <br/><code>python -m http.server 8000</code>
      <br/><span class="muted">Apoi deschide:</span> <code>http://localhost:8000/index.html</code>`,
      false
    );
  });
});

/** ======= UI hooks ======= **/
el('applyRange').addEventListener('click', renderChart);
el('addBtn').addEventListener('click', addExpense);
el('downloadBtn').addEventListener('click', () => downloadText('cheltuieli_updated.csv', toCSVWide()));
el('downloadLongBtn').addEventListener('click', () => downloadText('cheltuieli_long.csv', toCSVLong()));
</script>
</body>
</html>
