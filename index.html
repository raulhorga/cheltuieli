<!doctype html>
<html lang="ro">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Cheltuieli (SQLite)</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial; margin: 20px; line-height: 1.3; }
    .row { display: grid; grid-template-columns: 1fr; gap: 14px; max-width: 1250px; }
    .card { border: 1px solid #e5e7eb; border-radius: 14px; padding: 14px; box-shadow: 0 2px 10px rgba(0,0,0,.04); }
    .grid2 { display:grid; grid-template-columns: 2fr 1fr 1fr 1fr; gap:10px; }
    .grid { display: grid; grid-template-columns: repeat(4, minmax(0,1fr)); gap: 10px; }
    @media (max-width: 950px) { .grid, .grid2 { grid-template-columns: 1fr; } }
    label { font-size: 12px; color: #374151; display:block; margin-bottom: 6px; }
    input, button, textarea { width: 100%; box-sizing: border-box; padding: 10px; border-radius: 10px; border: 1px solid #d1d5db; }
    textarea { min-height: 42px; resize: vertical; }
    button { cursor:pointer; border: 0; }
    .btn { background:#111827; color:#fff; }
    .btn2 { background:#e5e7eb; color:#111827; }
    .muted { color:#6b7280; font-size: 12px; }
    code { background:#f3f4f6; padding:2px 6px; border-radius:8px; }

    .chartAndList { display:grid; grid-template-columns: 2fr 1fr; gap: 14px; align-items: start; }
    @media (max-width: 1100px) { .chartAndList { grid-template-columns: 1fr; } }
    .panelTitle { display:flex; align-items: baseline; justify-content: space-between; gap: 10px; margin: 0 0 8px 0; }
    .scroll { max-height: 520px; overflow: auto; border: 1px solid #e5e7eb; border-radius: 12px; }
    table { width: 100%; border-collapse: collapse; font-size: 12px; }
    thead th { position: sticky; top: 0; background: #fafafa; border-bottom: 1px solid #e5e7eb; text-align: left; padding: 10px; }
    tbody td { border-bottom: 1px solid #f0f0f0; padding: 10px; vertical-align: top; }
    tbody tr:hover { background: #fcfcfc; }
    .mono { font-variant-numeric: tabular-nums; }
    .right { text-align:right; }
    .small { font-size: 11px; color:#6b7280; }
    .danger { color:#991b1b; }
    .actions { display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
  </style>
</head>
<body>
  <div class="row">
    <div class="card">
      <h2 style="margin:0 0 8px 0;">Cheltuieli (SQLite)</h2>
      <div class="muted">
        Datele se salvează în <b>cheltuieli.sqlite</b> (local).
        Rulează: <code>python server.py</code> și deschide <code>http://localhost:8000</code>.
      </div>

      <div style="height:10px;"></div>

      <div class="grid2">
        <div>
          <label>Status</label>
          <div id="status" class="muted"></div>
        </div>
        <div>
          <label>De la data</label>
          <input id="fromDate" type="date" />
        </div>
        <div>
          <label>Până la data</label>
          <input id="toDate" type="date" />
        </div>
        <div style="display:flex; align-items:end;">
          <button class="btn2" id="applyRange">Aplică interval</button>
        </div>
      </div>

      <div style="height:12px;"></div>
      <div class="actions">
        <button class="btn2" id="reloadBtn">↻ Reîncarcă</button>
        <span class="small">Total intrări: <span id="totalCount">0</span></span>
      </div>

      <div style="height:14px;"></div>

      <div class="chartAndList">
        <div>
          <canvas id="chart"></canvas>
        </div>

        <div>
          <div class="panelTitle">
            <h3 style="margin:0;">Lista cheltuieli</h3>
            <div class="small"><span id="listCount">0</span> intrări</div>
          </div>
          <div class="small" style="margin:0 0 8px 0;">
            Cronologic, în intervalul selectat.
          </div>
          <div class="scroll">
            <table>
              <thead>
                <tr>
                  <th>Data</th>
                  <th>Categorie</th>
                  <th class="right">Sumă</th>
                  <th>Comentariu</th>
                  <th></th>
                </tr>
              </thead>
              <tbody id="expenseTbody">
                <tr><td colspan="5" class="muted">Încarc date...</td></tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <div class="card">
      <h3 style="margin:0 0 10px 0;">Adaugă cheltuială</h3>

      <div class="grid">
        <div>
          <label>Data</label>
          <input id="addDate" type="date" />
        </div>

        <div>
          <label>Categorie</label>
          <input id="addCategory" list="catList" placeholder="ex: alimentare" />
          <datalist id="catList"></datalist>
        </div>

        <div>
          <label>Sumă</label>
          <input id="addAmount" type="number" step="0.01" />
        </div>

        <div>
          <label>&nbsp;</label>
          <button class="btn" id="addBtn">Adaugă</button>
        </div>
      </div>

      <div style="height:10px;"></div>

      <div>
        <label>Comentariu (opțional)</label>
        <textarea id="addComment" placeholder="ex: prânz"></textarea>
      </div>

      <div id="addMsg" class="muted" style="margin-top:10px;"></div>
    </div>
  </div>

<script>
const el = (id) => document.getElementById(id);
let chart = null;
let expenses = [];

function setStatus(msg, ok=true){
  el('status').innerHTML = `<span style="color:${ok ? '#065f46' : '#991b1b'}">${msg}</span>`;
}

function pad2(x){ return String(x).padStart(2,'0'); }
function todayISO(){
  const d = new Date();
  return `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}`;
}

function uniq(arr){ return [...new Set(arr)]; }

function groupForChart(list){
  const dates = uniq(list.map(e => e.date)).sort();
  const cats = uniq(list.map(e => e.category)).sort();

  const map = new Map();
  for (const e of list){
    const k = `${e.date}|${e.category}`;
    map.set(k, (map.get(k) || 0) + Number(e.amount));
  }

  const datasets = cats.map(cat => ({
    label: cat,
    data: dates.map(dt => map.get(`${dt}|${cat}`) || 0),
    stack: 's1'
  }));

  return { labels: dates, datasets };
}

function renderChart(){
  const { labels, datasets } = groupForChart(expenses);
  if (chart) chart.destroy();
  chart = new Chart(el('chart'), {
    type: 'bar',
    data: { labels, datasets },
    options: {
      responsive: true,
      interaction: { mode: 'index', intersect: false },
      plugins: { legend: { position: 'bottom' } },
      scales: { x: { stacked:true }, y: { stacked:true, beginAtZero:true } }
    }
  });
}

function esc(s){
  return String(s || '').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
}

function renderList(){
  el('listCount').textContent = String(expenses.length);
  el('totalCount').textContent = String(expenses.length);

  const tbody = el('expenseTbody');
  if (!expenses.length){
    tbody.innerHTML = `<tr><td colspan="5" class="muted">Nu există cheltuieli în interval.</td></tr>`;
    return;
  }

  tbody.innerHTML = expenses.map(e => `
    <tr>
      <td class="mono">${esc(e.date)}</td>
      <td>${esc(e.category)}</td>
      <td class="right mono">${Number(e.amount).toFixed(2)}</td>
      <td>${esc(e.comment || '')}</td>
      <td class="right">
        <button class="btn2" data-del="${e.id}" title="Șterge">✕</button>
      </td>
    </tr>
  `).join('');

  tbody.querySelectorAll('button[data-del]').forEach(btn => {
    btn.addEventListener('click', async () => {
      const id = btn.getAttribute('data-del');
      if (!confirm('Ștergi această cheltuială?')) return;
      const res = await fetch(`/api/expenses/${id}`, { method: 'DELETE' });
      if (!res.ok) { alert('Eroare la ștergere'); return; }
      await loadAll();
    });
  });
}

async function loadCategories(){
  const res = await fetch('/api/categories', { cache: 'no-store' });
  if (!res.ok) return;
  const cats = await res.json();
  el('catList').innerHTML = cats.map(c => `<option value="${esc(c)}"></option>`).join('');
}

async function loadAll(){
  const f = el('fromDate').value || '';
  const t = el('toDate').value || '';
  const qs = new URLSearchParams();
  if (f) qs.set('from', f);
  if (t) qs.set('to', t);

  setStatus('Încarc...', true);
  const res = await fetch('/api/expenses?' + qs.toString(), { cache: 'no-store' });
  if (!res.ok){
    setStatus('Eroare la încărcare /api/expenses', false);
    return;
  }
  expenses = await res.json();
  setStatus(`OK: ${expenses.length} intrări`, true);

  renderChart();
  renderList();
  await loadCategories();
}

async function addExpense(){
  const date = el('addDate').value;
  const category = el('addCategory').value.trim();
  const amount = Number(el('addAmount').value);
  const comment = el('addComment').value.trim();

  if (!date) return el('addMsg').innerHTML = '<span class="danger">Alege o dată.</span>';
  if (!category) return el('addMsg').innerHTML = '<span class="danger">Scrie o categorie.</span>';
  if (!(amount > 0)) return el('addMsg').innerHTML = '<span class="danger">Introdu o sumă > 0.</span>';

  const res = await fetch('/api/expenses', {
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body: JSON.stringify({ date, category, amount, comment })
  });

  const payload = await res.json().catch(()=>null);
  if (!res.ok){
    el('addMsg').innerHTML = `<span class="danger">Eroare:</span> ${esc(payload?.error || 'necunoscut')}`;
    return;
  }

  el('addAmount').value = '';
  el('addComment').value = '';
  el('addMsg').innerHTML = `<span style="color:#065f46">OK</span> (id=${payload.id})`;
  await loadAll();
}

window.addEventListener('load', async () => {
  el('addDate').value = todayISO();

  const d = new Date();
  const to = todayISO();
  d.setDate(d.getDate() - 30);
  const from = `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}`;
  el('fromDate').value = from;
  el('toDate').value = to;

  await loadAll();
});

el('applyRange').addEventListener('click', loadAll);
el('reloadBtn').addEventListener('click', loadAll);
el('addBtn').addEventListener('click', addExpense);
</script>
</body>
</html>
